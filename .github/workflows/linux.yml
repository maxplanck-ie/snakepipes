name: linux

on: [pull_request, push]

defaults:
  run:
      shell: bash -l {0}


jobs:
  docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: 3.11
    - name: Install snakePipes
      run: |
        pip install .[docs]
    - name: docs
      run: |
        snakePipes config --tempDir /tmp
        cd docs
        make html
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: 3.11
    - name: Install snakePipes
      run: |
        pip install .[actions]
    - name: ruff
      run: |
        ruff check .
  CI:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: conda-incubator/setup-miniconda@v3
      with:
        environment-file: .github/conda_ci.yml
        activate-environment: conda_ci
        condarc-file: .github/condarc.yml
    - name: Install snakePipes
      run: |
        pip install .
    - name: print_conda_env_export
      run: |
        conda env export 
    - name: print_pip_list
      run: |
        pip list 
    - name: CI
      run: |
        snakePipes config --tempDir /tmp
        ./.ci_stuff/test_dag.sh
  createEnvs:
    needs: CI
    strategy:
      fail-fast: false
      matrix:
        envs: [
          'CONDA_SHARED_ENV',
          'CONDA_CREATE_INDEX_ENV',
          'CONDA_RNASEQ_ENV',
          'CONDA_RMATS_ENV',
          'CONDA_scRNASEQ_ENV',
          'CONDA_seurat3_ENV',
          'CONDA_loompy_ENV',
          'CONDA_alevinqc_ENV',
          'CONDA_eisaR_ENV',
          'CONDA_DNA_MAPPING_ENV',
          'CONDA_CHIPSEQ_ENV',
          'CONDA_ATAC_ENV',
          'CONDA_HIC_ENV',
          'CONDA_WGBS_ENV',
          'CONDA_DSS_ENV',
          'CONDA_RMD_ENV',
          'CONDA_PREPROCESSING_ENV',
          'CONDA_NONCODING_RNASEQ_ENV',
          'CONDA_SAMBAMBA_ENV',
          'CONDA_pysam_ENV'
        ]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: conda-incubator/setup-miniconda@v3
      with:
        environment-file: .github/snakePipesEnvCI.yml
        activate-environment: snakePipes_CI
        condarc-file: .github/condarc.yml
    - name: install snakePipes
      run: |
        pip install .
    - name: createEnvs
      run: |
        snakePipes config --tempDir /tmp
        snakePipes createEnvs --only ${{matrix.envs}}
